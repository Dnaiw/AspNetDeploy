@{
    ViewBag.Title = "Index";
    ViewBag.PageClass = "bundlesPage";

    Layout = "~/Views/Shared/_Layout.cshtml";
    BundleVersion bundleVersion = this.ViewBag.BundleVersion;

}

<div class="container">

    <h1>
        <div class="row">
            <div class="col-md-10">
                @bundleVersion.Bundle.Name @bundleVersion.Name <small>Bundle</small>
            </div>
            <div class="col-md-2 text-right">
                <button class="btn btn-default btn-lg">Configure</button>
            </div>
        </div>  
    </h1>

    <hr />

    @RenderSteps(bundleVersion, bundleVersion.DeploymentSteps)



</div>

@helper RenderSteps(BundleVersion bundleVersion, IEnumerable<DeploymentStep> steps)
{
    int stepCounter = 0;
    
    foreach (DeploymentStep deploymentStep in steps.OrderBy(ds => ds.OrderIndex))
    {
        stepCounter++;
        
        switch (deploymentStep.Type)
        {
            case DeploymentStepType.DeployWebSite:
                @RednerDeployWebSiteStep(bundleVersion, deploymentStep, stepCounter)
                break;

            case DeploymentStepType.RunPowerShellScript:
                @RenderRunPowerShellScript(bundleVersion, deploymentStep, stepCounter)
                break;

            case DeploymentStepType.CopyFiles:
                @RenderCopyFiles(bundleVersion, deploymentStep, stepCounter)
                break;
        }
        <br/>
    }
}

@helper RednerDeployWebSiteStep(BundleVersion bundleVersion, DeploymentStep deploymentStep, int stepCounter)
{
    ProjectVersion projectVersion = bundleVersion.ProjectVersions.First(p => p.Id == deploymentStep.GetIntProperty("ProjectId", 0));

    <h3>@(stepCounter). Deploy: @deploymentStep.GetStringProperty("IIS.SiteName") <small>IIS</small></h3>
    <div class="row text-muted">
        <div class="col-md-4">
            <ul>
                <li>Roles:
                                
                    @foreach (MachineRole role in deploymentStep.MachineRoles)
                    {
                        <span class="label label-default">@role.Name</span>
                    }
                </li>
                <li>Source: @projectVersion.SourceControlVersion.Name / @projectVersion.Name</li>
                <li>Destination: @deploymentStep.GetStringProperty("IIS.DestinationPath")</li>
                <li>Enabled AppOffilne page: @deploymentStep.GetStringProperty("EnabledAppOffilnePage")</li>
                <li>Bindings:
                    <ul>
                                    
                        @foreach (dynamic binding in deploymentStep.GetDynamicProperties("IIS.Binding"))
                        {
                            <li>@binding.type, @binding.port, @binding.host</li>
                        }
                    </ul>
                </li>
            </ul>
        </div>
    </div>
}

@helper RenderRunPowerShellScript(BundleVersion bundleVersion, DeploymentStep deploymentStep, int stepCounter)
{
    <h3>@(stepCounter). Script: @deploymentStep.GetStringProperty("Step.Title") <small>PowerShell</small></h3>
}



}

@helper RenderCopyFiles(BundleVersion bundleVersion, DeploymentStep deploymentStep, int stepCounter)
{
    <h3>@(stepCounter). Copy: @deploymentStep.GetStringProperty("Step.Title") <small>Copy</small></h3>
}



